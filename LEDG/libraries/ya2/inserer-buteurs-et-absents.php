<?phpdefined('_JEXEC') or die( 'Restricted access' );require_once ('libraries/ya2/fonctions_ledg.php');$user =& JFactory::getUser();$db = & JFactory::getDBO();$jour_fr = array("Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi");$mois_fr = array("Janvier", "F&eacute;vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "D&eacute;cembre");if (test_non_vide($_POST["equipe_gagnante"]) and test_non_vide($_POST["num_match"])) {                $query1 = "UPDATE #__bl_match SET m_played=1, score1=5, score2=0  "                ." where id=".$_POST["num_match"]." and team1_id=".$_POST["equipe_gagnante"];                //echo  $query1;        $db->setQuery($query1);        $db->query();                $query2 = "UPDATE #__bl_match SET m_played=1, score1=0, score2=5 "                ." where id=".$_POST["num_match"]." and team2_id=".$_POST["equipe_gagnante"];                //echo  $query2;        $db->setQuery($query2);        $db->query();		if (recup_1_element("k_format","#__bl_matchday","id",$_POST["m_id"])>0)		maj_match_knock($_POST["num_match"],$_POST["m_id"],$_POST["equipe_gagnante"],$_POST["k_ordering"],$_POST["k_stage"]);			header("Location: inserer-resultats");}if (est_agent($user)){if (test_non_vide($_GET["id_equipe_suppr_score"]) and test_non_vide($_GET["id_match_suppr_score"])) {                $query1 = "UPDATE #__bl_match SET m_played=0, score1=0  "                ." where id=".$_GET["id_match_suppr_score"]." and team1_id=".$_GET["id_equipe_suppr_score"];                //echo  $query1;        $db->setQuery($query1);        $db->query();                $query2 = "UPDATE #__bl_match SET m_played=0, score2=0 "                ." where id=".$_GET["id_match_suppr_score"]." and team2_id=".$_GET["id_equipe_suppr_score"];                //echo  $query2;        $db->setQuery($query2);        $db->query();		$query3="DELETE FROM #__bl_match_events WHERE player_id in (SELECT id from #__bl_players where team_id="		  .$_GET["id_equipe_suppr_score"].") and match_id=".$_GET["id_match_suppr_score"];	        //echo  $query3;        $db->setQuery($query3);        $db->query();	$m_id_a_maj=recup_1_element("m_id","#__bl_match","id",$_GET["id_match_suppr_score"]);	if (recup_1_element("k_format","#__bl_matchday","id",$m_id_a_maj)>0){// dans le cas de la phase finale d'une coupe		$k_stage_a_maj=recup_1_element("k_stage","#__bl_match","id",$_GET["id_match_suppr_score"]);						$query1 = "UPDATE #__bl_match SET m_played=0, score1=0,team1_id=0  "			." where m_id=".$m_id_a_maj." and k_stage>".$k_stage_a_maj." and team1_id=".$_GET["id_equipe_suppr_score"];        		echo  $query1;		$db->setQuery($query1);		$db->query();				$query2 = "UPDATE #__bl_match SET m_played=0, score2=0,team2_id=0   "			." where m_id=".$m_id_a_maj." and k_stage>".$k_stage_a_maj." and team2_id=".$_GET["id_equipe_suppr_score"];        		echo  $query2;		$db->setQuery($query2);		$db->query();	}			header("Location: inserer-resultats");}if (test_non_vide($_GET["id_equipe_bonus_retard"]) and test_non_vide($_GET["id_match_bonus_retard"]) and test_non_vide($_GET["score"])) {                $query1 = "UPDATE #__bl_match SET score1=".($_GET["score"]+5)."  "                ." where id=".$_GET["id_match_bonus_retard"]." and team1_id=".$_GET["id_equipe_bonus_retard"];                //echo  $query1;        $db->setQuery($query1);        $db->query();                $query2 = "UPDATE #__bl_match SET score2=".($_GET["score"]+5)." "                ." where id=".$_GET["id_match_bonus_retard"]." and team2_id=".$_GET["id_equipe_bonus_retard"];                //echo  $query2;        $db->setQuery($query2);        $db->query();		header("Location: ../../index.php/component/joomsport/view_match/".$_GET["id_match_bonus_retard"]."?Itemid=0");}if (test_non_vide($_GET["id_equipe_fairplay"]) and test_non_vide($_GET["id_match_fairplay"]) and test_non_vide($_GET["fairplay"])) {                $query1 = "UPDATE #__bl_match SET bonus1=".($_GET["fairplay"])."  "                ." where id=".$_GET["id_match_fairplay"]." and team1_id=".$_GET["id_equipe_fairplay"];                //echo  $query1;        $db->setQuery($query1);        $db->query();                $query2 = "UPDATE #__bl_match SET bonus2=".($_GET["fairplay"])." "                ." where id=".$_GET["id_match_fairplay"]." and team2_id=".$_GET["id_equipe_fairplay"];                //echo  $query2;        $db->setQuery($query2);        $db->query();		header("Location: ../../index.php/component/joomsport/view_match/".$_GET["id_match_fairplay"]."?Itemid=0");}if (test_non_vide($_POST["juste_score"]) and test_non_vide($_POST["num_match_juste_score"]) and test_non_vide($_POST["equipe_id_juste_score"])) {	 	 $requete_scores_deja_insere="SELECT count(id) FROM #__bl_match WHERE (score1<>0 or score2<>0) and `id`=".$_POST["num_match_juste_score"];	 //echo $requete_scores_deja_insere;	 $db->setQuery($requete_scores_deja_insere);	 $resultat_scores_deja_insere = $db->loadResult();			   	 if ($resultat_scores_deja_insere>0)		  $complement_requete=" , m_played=1 ";	 else $complement_requete="";			   	 $query_juste_score1="UPDATE #__bl_match SET score1=".$_POST["juste_score"]." ".$complement_requete." WHERE id =".$_POST["num_match_juste_score"]." AND team1_id=".$_POST["equipe_id_juste_score"].";";	 $db->setQuery($query_juste_score1);	 $db->query();		 $query_juste_score2="UPDATE #__bl_match SET score2=".$_POST["juste_score"]." ".$complement_requete." WHERE id =".$_POST["num_match_juste_score"]." AND team2_id=".$_POST["equipe_id_juste_score"].";";	 $db->setQuery($query_juste_score2);	 $db->query();	 	if (recup_1_element("k_format","#__bl_matchday","id",$_POST["m_id"])>0)		maj_match_knock($_POST["num_match_juste_score"],$_POST["m_id"],$_POST["equipe_id_juste_score"],$_POST["k_ordering"],$_POST["k_stage"]);	 	header("Location: inserer-resultats");}}if (isset($_POST["match_id"]) or isset($_POST["requetes"]) ){	 $cumul_requetes="";	 	 if (isset($_POST["requetes"])) {	       $les_requetes= explode(";",str_replace("\\","",$_POST["requetes"]));	       foreach ($les_requetes as $req) {		   $db->setQuery($req);			   $db->query();	       }	       if (recup_1_element("k_format","#__bl_matchday","id",$_POST["m_id"])>0)		       maj_match_knock($_POST["match_id"],$_POST["m_id"],$_POST["equipe_id"],$_POST["k_ordering"],$_POST["k_stage"]);		       		if (isset($_POST["match_id"])) {			 if (est_agent($user))				  header("Location: inserer-resultats");			 else header("Location: ../ep");		}		else echo "insertion r&eacute;ussie !";					 }	 else {	 		  $requete_max_num_joueur="SELECT max(player_id) as max_num_joueur FROM #__bl_players_team where season_id in (".liste_saisons_avec_virgules(capitaine_equipe($_POST["equipe_id"])).") ";		  //echo $requete_max_num_joueur;		  $db->setQuery($requete_max_num_joueur);		  $resultat_max_num_joueur = $db->loadObjectList();		  		  foreach ($resultat_max_num_joueur as $row_max_num_joueur){			   echo "<FORM id=formulaire name=formulaire action=\"inserer-resultats\" method=post>";			   			   			   			   //echo "<br />--Les buteurs<br />";			   $buts_equipe=0;			   for ($k = 0; $k <= $row_max_num_joueur->max_num_joueur; $k++){			      if (($_POST["SELECT$k"]<>"") and ($_POST["SELECT$k"]<>0)) {				   $cumul_requetes=$cumul_requetes."INSERT INTO #__bl_match_events (e_id,player_id,match_id,ecount,minutes,t_id,id) VALUES('1',".$k.",".$_POST["match_id"].",".$_POST["SELECT$k"].",'',".$_POST["equipe_id"].",NULL);";				   $buts_equipe=$buts_equipe+$_POST["SELECT$k"];			      }			   }			   			   //echo "<br />--Les resultats<br />";			   			   $requete_scores_deja_insere="SELECT IF(score1=0,IF(score2=0,0,score2),score1) FROM #__bl_match WHERE `id`=".$_POST["match_id"];			   //echo $requete_scores_deja_insere;			   $db->setQuery($requete_scores_deja_insere);			   $resultat_scores_deja_insere = $db->loadResult();			   			   if ($resultat_scores_deja_insere>0)				    $complement_requete=" , m_played=1 ";			   else $complement_requete="";			   			   if ($buts_equipe<>""){				$cumul_requetes.="UPDATE #__bl_match SET score1=".$buts_equipe." ".$complement_requete." WHERE id =".$_POST["match_id"]." AND team1_id=".$_POST["equipe_id"].";";				$cumul_requetes.="UPDATE #__bl_match SET score2=".$buts_equipe." ".$complement_requete." WHERE id =".$_POST["match_id"]." AND team2_id=".$_POST["equipe_id"].";";				   								   			   }			   			   			   //echo "<br />--Les absents<br />";			   $absents_equipe=0;			   $test=0;			   for ($k = 0; $k <= $row_max_num_joueur->max_num_joueur; $k++){				   if ($_POST["CB$k"]=="1") {				       if (($_POST["SELECT$k"]<>"") and ($_POST["SELECT$k"]<>0)) {					   echo "<br />Tu as s&eacute;lectionn&eacute; un joueur comme &eacute;tant &agrave; la fois absent et buteur !!!<br />";					   $test++;								   //exit;				      }				   $cumul_requetes=$cumul_requetes."INSERT INTO #__bl_match_events (e_id,player_id,match_id,ecount,minutes,t_id,id) VALUES('2',".$k.",".$_POST["match_id"].",".$_POST["CB$k"].",'',".$_POST["equipe_id"].",NULL);";				   $absents_equipe++;				  }			   }			   			   echo "<TEXTAREA rows=\"3\" name=\"requetes\" style=\"display:none;\">".$cumul_requetes."";			   echo "</TEXTAREA>";			   echo "<input type=\"hidden\" name=\"match_id\" value=".$_POST["match_id"].">";			    echo "<input name=\"equipe_id\" type=\"hidden\" value=".$_POST["equipe_id"].">";			   if ($test==0) {			   			   echo "Confirmes-tu que ton &eacute;quipe a marqu&eacute;e ".$buts_equipe." but(s) et qu'il y a eu ".$absents_equipe." absent(s) ?"				."<input name=\"m_id\" type=\"hidden\" value=".$_POST["m_id"].">"			   ."<input name=\"k_ordering\" type=\"hidden\" value=".$_POST["k_ordering"].">"			   ."<input name=\"k_stage\" type=\"hidden\" value=".$_POST["k_stage"].">";			   			   echo "<br /><br /><center><input name=\"valide\" type=\"submit\"  value=\"Enregistrer\"> </form><br /></center>";			   }		  }	 }} else {if (!test_saisie($user->id)){$id_equipe_user=equipe_du_joueur($user->id);$nom_equipe_user=equipe_du_joueur($user->id,0);if (est_agent($user))  {	 $complement_req1="";	 $complement_req2="";	 $complement_req3="  left join #__bl_teams as t1 on t1.id=m.`team1_id` left join #__bl_teams as t2 on t2.id=m.`team2_id` where ";	 $compl_req0=" t1.t_name as nom_equipe_adv, t1.id as t1id, t2.t_name as nom_equipe, t2.id as t2id,  ";	 //$compl_req4= " and TIMESTAMPDIFF(MINUTE,CAST(concat(m.m_date,\" \",m.m_time) AS CHAR(22)),NOW())>-5760 ";}else  {	 $complement_req1="m.`team1_id`=".$id_equipe_user." and ";	 $complement_req2="m.`team2_id`=".$id_equipe_user." and ";	 $complement_req3=" , #__bl_teams as t where (t.id=m.`team1_id` or t.id=m.`team2_id`) and t.id<>".$id_equipe_user." and ";	 $compl_req0=" t.t_name as nom_equipe_adv, t.id as id_equipe_adv, ";	 $compl_req4=" and TIMESTAMPDIFF(MINUTE,CAST(concat(m.m_date,\" \",m.m_time) AS CHAR(22)),NOW())<=10080 "		." and TIMESTAMPDIFF(MINUTE,CAST(concat(m.m_date,\" \",m.m_time) AS CHAR(22)),NOW())>0 ";}$query_equipe_adv = "SELECT (TO_DAYS(NOW())-TO_DAYS(m.`m_date`)) as nbre_jours,m.id as Num_Match, m.m_time as heure, m.m_date as jour_match ,";$query_equipe_adv .= $compl_req0." m.team1_id, m.team2_id,m.score1,m.score2,m.m_id,m.k_ordering,m.k_stage FROM #__bl_match as m ".$complement_req3;$query_equipe_adv .= " m.m_played=0 and m.`published`=1 ";$query_equipe_adv .= " and ((".$complement_req1." m.score1=0)  or  (".$complement_req2." m.score2=0)) ".$compl_req4;$query_equipe_adv .= "  order by m.m_date asc ,m.m_time asc  LIMIT ".(0+$_GET["suiv"]).",1  ";//echo "<br>query_equipe_adv".$query_equipe_adv;$db->setQuery($query_equipe_adv);$equipe_adv = $db->loadObject();if (!$equipe_adv) {if (!est_agent($user))  echo "Les buteurs et absents du dernier match ont d&eacute;j&agrave; &eacute;t&eacute; ins&eacute;r&eacute;s.<br />"; }else {if (est_agent($user)) { 	 if ($equipe_adv->score1==0){		  $complement_req=" t.id=".$equipe_adv->t1id." ";		  $contre_qui_id=$equipe_adv->t2id;		  $contre_qui=$equipe_adv->nom_equipe;	 }	 else {		  $complement_req=" t.id=".$equipe_adv->t2id." ";		  $contre_qui=$equipe_adv->nom_equipe_adv;		  $contre_qui_id=$equipe_adv->t1id;	 }}else  {	 $complement_req=" t.id=".$id_equipe_user." ";	 $contre_qui=$equipe_adv->nom_equipe_adv;	 $contre_qui_id=$equipe_adv->id_equipe_adv;}$requete_match="SELECT md.id, m.m_date as Date, m.m_time as creneau, m.m_location as Terrain, m.id as match_id, t.id as Num_Equipe, t.t_name as Nom_Equipe ";$requete_match.="FROM #__bl_match as m, #__bl_teams as t,  #__bl_matchday as md where (m.`team1_id`=t.id or m.`team2_id`=t.id) ";$requete_match.=" and m.id=\"".$equipe_adv->Num_Match."\" and md.id=m.m_id and ".$complement_req." order by  creneau, Terrain,m.id, t.t_name";//echo "<br>requete_match".$requete_match;$db->setQuery($requete_match);$resultat_match = $db->loadObject();echo "<FORM id=formulaire name=formulaire action=\"inserer-resultats\" method=post>";	 list( $annee, $mois,$jour) = explode('-',$resultat_match->Date);	 $date_longue = mktime (0, 0, 0, $mois, $jour, $annee);	 if (est_agent($user)) 		echo "<hr><table width=\"100%\"><tr><td align=\"left\"><a  title=\"Match precedent\" href=\"index.php/ep/inserer-resultats?suiv=".($_GET["suiv"]-1)."\">Match precedent</a></td><td align=\"right\"><a  title=\"Match suivant\" href=\"index.php/ep/inserer-resultats?suiv=".(1+$_GET["suiv"])."\">Match suivant</a></td></tr></table><hr>";  	 	 echo "Match : <b>".$resultat_match->Nom_Equipe."</b> contre ".$contre_qui." du <b>".$jour_fr[date("w", $date_longue)]." ".$jour." ".$mois_fr[date("n", $date_longue)-1]." ".$annee." </b>  &agrave; ".$equipe_adv->heure." ";	 $feuile_match=recup_nom_feuille_match($resultat_match->match_id);	 if (test_non_vide($feuile_match))		  echo "<br><br><center><a  title=\"feuille de match\" href=\"".$feuile_match."\"  target=\"_blank\"><img src=\"images/stories/feuille-de-match-scan.png\"  alt=\"Scan de la feuille de match\"></a></center>";	 echo "<br /><br />";	 	 echo "<input name=\"match_id\" type=\"hidden\" value=".$resultat_match->match_id.">";	 echo "<input name=\"equipe_id\" type=\"hidden\" value=".$resultat_match->Num_Equipe.">";if (diff_dates_en_jours($resultat_match->Date)>=0){	 	 	 echo "<table class=\"zebra\" border=0 width=\"100%\">";	 echo "<thead><tr><th align=\"center\">Pr&eacute;nom</th><th align=\"center\">Flocage</th>"		  ."<th align=\"center\">Num maillot</th><th align=\"center\">Absent</th><th align=\"center\">Nbre de buts</th></tr></thead>";	 	 $requete_buteurs="SELECT p.id as Num_Joueur, p.first_name as Prenom, p.nick as Flocage, (SELECT (fvalue-21) as num "			   ." FROM  #__bl_extra_values where uid=p.id and f_id=4)as Num_maillot  "			   ." FROM #__bl_teams as t,  #__bl_players as p "			   ." where t.id=\"".$resultat_match->Num_Equipe."\" and t.id in (select pt.team_id FROM #__bl_players_team as pt Where p.id=pt.player_id and pt.season_id in (".liste_saisons_avec_virgules(capitaine_equipe($resultat_match->Num_Equipe)).")) "			   ." order by  Num_maillot";	 $db->setQuery($requete_buteurs);	 	 $resultat_buteurs = $db->loadObjectList();	 	 foreach ($resultat_buteurs as $row_buteurs ){		  echo "<tr><td>".$row_buteurs->Prenom."</td><td>".$row_buteurs->Flocage."</td><td>";		  if ($row_buteurs->Num_maillot >=0) echo $row_buteurs->Num_maillot;		  echo "</td><td>";		  if ($row_buteurs->Prenom<>"Csc") echo "<INPUT type=\"checkbox\" name=\"CB".$row_buteurs->Num_Joueur."\" value=\"1\">"; else echo " ";		  echo "</td><td><select name=\"SELECT".$row_buteurs->Num_Joueur."\">";		  for ($k = 0; $k <= 20; $k++) echo "<OPTION  value=".$k.">".$k."</OPTION>";		  echo "</select></td></tr>";	 }		  	 echo "</table>"		."<input name=\"m_id\" type=\"hidden\" value=".$equipe_adv->m_id.">"		."<input name=\"k_ordering\" type=\"hidden\" value=".$equipe_adv->k_ordering.">"		."<input name=\"k_stage\" type=\"hidden\" value=".$equipe_adv->k_stage.">";echo "<center><br /><input name=\"valide\" type=\"submit\" class=\"Style7\" value=\"Enregistrer les buteurs & absents\"> </form><br /></center>";if (est_agent($user)){	 echo "<hr><FORM name=\"form2\" class=\"submission box\" action=\"inserer-resultats\" method=post >";                    		  echo "<input name=\"num_match_juste_score\" type=\"hidden\"  value=\"".$equipe_adv->Num_Match."\" >";		  echo "Enregistrer seulement le score (sans les buteurs et absents) : "			   ."<input name=\"juste_score\" type=\"text\"  value=\"\" size=2>"			   ."<input name=\"equipe_id_juste_score\" type=\"hidden\" value=".$resultat_match->Num_Equipe.">"			   ."<input name=\"m_id\" type=\"hidden\" value=".$equipe_adv->m_id.">"			   ."<input name=\"k_ordering\" type=\"hidden\" value=".$equipe_adv->k_ordering.">"			   ."<input name=\"k_stage\" type=\"hidden\" value=".$equipe_adv->k_stage.">";                            echo " <input name=\"valide2\" type=\"submit\"  value=\"enregistrer\" >";         echo "</form><br />";}}	 echo "<br><hr><br><FORM name=\"form3\" class=\"submission box\" action=\"inserer-resultats\" method=post >";                    		  echo "<input name=\"num_match\" type=\"hidden\"  value=\"".$equipe_adv->Num_Match."\" >";		  echo "Declarer ce match gagnant par forfait pour : <select name=\"equipe_gagnante\">"			   ."<option value=\"".$resultat_match->Num_Equipe."\">".$resultat_match->Nom_Equipe."</option>"			   ."<option value=\"".$contre_qui_id."\">".$contre_qui."</option>"			   ."</select>"			   ."<input name=\"m_id\" type=\"hidden\" value=".$equipe_adv->m_id.">"			   ."<input name=\"k_ordering\" type=\"hidden\" value=".$equipe_adv->k_ordering.">"			   ."<input name=\"k_stage\" type=\"hidden\" value=".$equipe_adv->k_stage.">";                            echo " <input name=\"valide3\" type=\"submit\"  value=\"Enregistrer ce forfait\" >";         echo "</form><br />";}}else header("Location: ../ep");}?>